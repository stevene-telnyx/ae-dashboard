<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AE Dashboard - ROE Tracker</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #e7e9ea;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2f3336;
        }
        h1 { font-size: 24px; font-weight: 600; }
        .sync-info { color: #71767b; font-size: 14px; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-value { font-size: 36px; font-weight: 700; }
        .stat-label { color: #71767b; margin-top: 4px; }
        .stat-expired .stat-value { color: #f4212e; }
        .stat-expiring .stat-value { color: #ffd400; }
        .stat-active .stat-value { color: #00ba7c; }
        .stat-none .stat-value { color: #71767b; }
        .stat-hot .stat-value { color: #f97316; }
        
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-btn {
            background: #16181c;
            border: 1px solid #2f3336;
            color: #e7e9ea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #1d1f23; }
        .filter-btn.active { background: #1d9bf0; border-color: #1d9bf0; }
        .filter-btn.hot-filter.active { background: #f97316; border-color: #f97316; }
        .filter-btn.opp-filter.active { background: #eab308; border-color: #eab308; color: #000; }
        .filter-btn.notes-filter.active { background: #a855f7; border-color: #a855f7; }
        
        .search {
            background: #16181c;
            border: 1px solid #2f3336;
            color: #e7e9ea;
            padding: 12px 16px;
            border-radius: 8px;
            width: 300px;
            font-size: 14px;
        }
        .search::placeholder { color: #71767b; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #16181c;
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid #2f3336;
        }
        th {
            background: #1d1f23;
            font-weight: 600;
            color: #71767b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
        }
        th:hover { color: #e7e9ea; }
        th.sorted-asc::after { content: ' ‚Üë'; }
        th.sorted-desc::after { content: ' ‚Üì'; }
        tr:hover { background: #1d1f23; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-expired { background: #f4212e20; color: #f4212e; }
        .status-expiring_soon { background: #ffd40020; color: #ffd400; }
        .status-active { background: #00ba7c20; color: #00ba7c; }
        .status-no_activity { background: #71767b20; color: #71767b; }
        
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .priority-P1 { background: #f4212e; color: white; }
        .priority-P2 { background: #ffd400; color: black; }
        .priority-P3 { background: #71767b; color: white; }
        .priority-none { background: transparent; color: #71767b; }
        
        .hot-toggle {
            cursor: pointer;
            font-size: 18px;
            opacity: 0.3;
            transition: opacity 0.2s, transform 0.1s;
            user-select: none;
        }
        .hot-toggle:hover { opacity: 0.6; transform: scale(1.1); }
        .hot-toggle.is-hot { opacity: 1; }
        
        .opp-indicator { font-size: 18px; }
        .opp-none { opacity: 0.15; }
        
        .days-remaining { font-weight: 600; font-variant-numeric: tabular-nums; }
        .days-negative { color: #f4212e; }
        .days-warning { color: #ffd400; }
        .days-ok { color: #00ba7c; }
        
        a { color: #1d9bf0; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        .account-name { font-weight: 500; }
        .account-meta { color: #71767b; font-size: 12px; }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #71767b;
        }
        
        .export-btn {
            background: #2f3336;
            border: none;
            color: #e7e9ea;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .export-btn:hover { background: #3a3f44; }
        
        .note-cell {
            min-width: 200px;
            max-width: 300px;
        }
        .note-input {
            background: transparent;
            border: 1px solid transparent;
            color: #e7e9ea;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%;
            transition: all 0.2s;
        }
        .note-input:hover {
            background: #1d1f23;
            border-color: #2f3336;
        }
        .note-input:focus {
            background: #1d1f23;
            border-color: #1d9bf0;
            outline: none;
        }
        .note-input::placeholder {
            color: #71767b;
            font-style: italic;
        }
        .note-input.has-note {
            color: #a855f7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä AE Dashboard - Steven Econs</h1>
        <div class="sync-info">Data: <span id="syncTime">Loading...</span></div>
    </div>
    
    <div class="stats">
        <div class="stat-card stat-hot">
            <div class="stat-value" id="hotCount">-</div>
            <div class="stat-label">üî• Hot Accounts</div>
        </div>
        <div class="stat-card stat-active">
            <div class="stat-value" id="activeCount">-</div>
            <div class="stat-label">üü¢ Active</div>
        </div>
        <div class="stat-card stat-expiring">
            <div class="stat-value" id="expiringCount">-</div>
            <div class="stat-label">üü° Expiring Soon</div>
        </div>
        <div class="stat-card stat-none">
            <div class="stat-value" id="noActivityCount">-</div>
            <div class="stat-label">‚ö™ No Activity</div>
        </div>
    </div>
    
    <div class="filters">
        <button class="filter-btn active" data-filter="all" data-type="all">All</button>
        <button class="filter-btn hot-filter" data-filter="hot" data-type="hot">üî• Hot</button>
        <button class="filter-btn notes-filter" data-filter="has_notes" data-type="has_notes">üìù With Notes</button>
        <button class="filter-btn opp-filter" data-filter="open_opp" data-type="open_opp">üí∞ Open Opps</button>
        <span style="color:#2f3336; margin: 0 8px;">|</span>
        <button class="filter-btn" data-filter="P1" data-type="priority">üî¥ P1</button>
        <button class="filter-btn" data-filter="P2" data-type="priority">üü° P2</button>
        <button class="filter-btn" data-filter="P3" data-type="priority">‚ö™ P3</button>
        <span style="color:#2f3336; margin: 0 8px;">|</span>
        <button class="filter-btn" data-filter="expired" data-type="roe">ROE Expired</button>
        <button class="filter-btn" data-filter="expiring_soon" data-type="roe">ROE Expiring</button>
        <input type="text" class="search" placeholder="Search accounts..." id="searchInput">
        <button class="export-btn" onclick="exportData()">üì§ Export</button>
        <button class="export-btn" onclick="publishHotAccounts()" style="background:#f97316;">üî• Publish Hot</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th data-sort="hot">üî•</th>
                <th data-sort="opp">üí∞</th>
                <th data-sort="priority">P</th>
                <th data-sort="name">Account</th>
                <th data-sort="status">ROE Status</th>
                <th data-sort="days">Days</th>
                <th data-sort="notes">Notes</th>
            </tr>
        </thead>
        <tbody id="accountsTable"></tbody>
    </table>

    <script>
        let allAccounts = [];
        let currentFilter = 'all';
        let currentFilterType = 'all';
        let sortColumn = 'days';
        let sortDirection = 'asc';
        let sharedHotAccounts = {}; // From repo
        
        // Hot accounts - combines shared (repo) + local (localStorage)
        function getLocalHotAccounts() {
            const stored = localStorage.getItem('hotAccounts');
            return stored ? JSON.parse(stored) : {};
        }
        
        function getHotAccounts() {
            // Merge shared + local (local overrides)
            return { ...sharedHotAccounts, ...getLocalHotAccounts() };
        }
        
        function setLocalHotAccounts(hot) {
            localStorage.setItem('hotAccounts', JSON.stringify(hot));
            updateHotCount();
        }
        
        function toggleHot(accountId) {
            const local = getLocalHotAccounts();
            const combined = getHotAccounts();
            
            if (combined[accountId]) {
                // Remove: if it's shared, mark as removed locally; if local, just delete
                local[accountId] = false; // false = explicitly removed
            } else {
                local[accountId] = Date.now();
            }
            setLocalHotAccounts(local);
            renderTable(filterAndSortAccounts());
        }
        
        function isHot(accountId) {
            const local = getLocalHotAccounts();
            // If explicitly set to false locally, it's not hot
            if (local[accountId] === false) return false;
            // Otherwise check combined
            return !!getHotAccounts()[accountId];
        }
        
        function updateHotCount() {
            const combined = getHotAccounts();
            const local = getLocalHotAccounts();
            // Count accounts that are hot (not explicitly removed)
            const count = Object.keys(combined).filter(id => {
                if (local[id] === false) return false;
                return combined[id];
            }).length;
            document.getElementById('hotCount').textContent = count;
        }
        
        async function loadSharedHotAccounts() {
            try {
                const resp = await fetch('hot-accounts.json');
                sharedHotAccounts = await resp.json();
            } catch (e) {
                console.log('No shared hot accounts file');
                sharedHotAccounts = {};
            }
        }
        
        function publishHotAccounts() {
            // Get all currently hot accounts (for publishing to shared)
            const local = getLocalHotAccounts();
            const publish = {};
            
            // Start with shared
            Object.keys(sharedHotAccounts).forEach(id => {
                if (local[id] !== false) {
                    publish[id] = sharedHotAccounts[id];
                }
            });
            
            // Add local additions
            Object.keys(local).forEach(id => {
                if (local[id] && local[id] !== false) {
                    publish[id] = local[id];
                }
            });
            
            const text = JSON.stringify(publish, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                alert(`Copied ${Object.keys(publish).length} hot accounts!\n\nSend this to Dwight to update the shared list.`);
            }).catch(() => {
                prompt('Copy this and send to Dwight:', text);
            });
        }
        
        // Notes - localStorage persistence
        function getNotes() {
            const stored = localStorage.getItem('accountNotes');
            return stored ? JSON.parse(stored) : {};
        }
        
        function setNote(accountId, note) {
            const notes = getNotes();
            if (note && note.trim()) {
                notes[accountId] = note.trim();
            } else {
                delete notes[accountId];
            }
            localStorage.setItem('accountNotes', JSON.stringify(notes));
        }
        
        function getNote(accountId) {
            return getNotes()[accountId] || '';
        }
        
        function handleNoteChange(accountId, inputEl) {
            setNote(accountId, inputEl.value);
            inputEl.classList.toggle('has-note', !!inputEl.value.trim());
        }
        
        function exportData() {
            const hot = getHotAccounts();
            const notes = getNotes();
            
            const exportList = allAccounts
                .filter(a => hot[a.salesforce_id] || notes[a.salesforce_id])
                .map(a => ({
                    name: a.name,
                    id: a.salesforce_id,
                    url: a.salesforce_url,
                    hot: !!hot[a.salesforce_id],
                    note: notes[a.salesforce_id] || ''
                }));
            
            const text = JSON.stringify(exportList, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                alert(`Copied ${exportList.length} accounts (hot + notes) to clipboard!`);
            }).catch(() => {
                prompt('Copy this:', text);
            });
        }
        
        async function loadData() {
            try {
                // Load shared hot accounts first
                await loadSharedHotAccounts();
                
                const resp = await fetch('accounts.json');
                const data = await resp.json();
                
                document.getElementById('syncTime').textContent = new Date(data.synced_at).toLocaleDateString();
                document.getElementById('expiringCount').textContent = data.summary.expiring_soon;
                document.getElementById('activeCount').textContent = data.summary.active;
                document.getElementById('noActivityCount').textContent = data.summary.no_activity;
                updateHotCount();
                
                allAccounts = data.accounts;
                renderTable(filterAndSortAccounts());
            } catch (e) {
                console.error('Error loading data:', e);
                document.getElementById('accountsTable').innerHTML = 
                    '<tr><td colspan="7" class="empty-state">Error loading data.</td></tr>';
            }
        }
        
        function filterAndSortAccounts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const notes = getNotes();
            let filtered = allAccounts;
            
            // Apply filter
            if (currentFilter !== 'all') {
                if (currentFilterType === 'hot') {
                    filtered = filtered.filter(a => isHot(a.salesforce_id));
                } else if (currentFilterType === 'has_notes') {
                    filtered = filtered.filter(a => notes[a.salesforce_id]);
                } else if (currentFilterType === 'open_opp') {
                    filtered = filtered.filter(a => a.has_open_opp);
                } else if (currentFilterType === 'priority') {
                    filtered = filtered.filter(a => a.priority === currentFilter);
                } else if (currentFilterType === 'roe') {
                    filtered = filtered.filter(a => a.roe_status === currentFilter);
                }
            }
            
            // Apply search
            if (search) {
                filtered = filtered.filter(a => 
                    a.name.toLowerCase().includes(search) ||
                    (a.industry && a.industry.toLowerCase().includes(search)) ||
                    (a.city && a.city.toLowerCase().includes(search)) ||
                    (notes[a.salesforce_id] && notes[a.salesforce_id].toLowerCase().includes(search))
                );
            }
            
            // Sort
            filtered.sort((a, b) => {
                let aVal, bVal;
                switch(sortColumn) {
                    case 'hot':
                        aVal = isHot(a.salesforce_id) ? 1 : 0;
                        bVal = isHot(b.salesforce_id) ? 1 : 0;
                        break;
                    case 'opp':
                        aVal = a.has_open_opp ? 1 : 0;
                        bVal = b.has_open_opp ? 1 : 0;
                        break;
                    case 'priority':
                        const pOrder = { 'P1': 1, 'P2': 2, 'P3': 3 };
                        aVal = pOrder[a.priority] || 99;
                        bVal = pOrder[b.priority] || 99;
                        break;
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'status':
                        const sOrder = { 'expired': 1, 'expiring_soon': 2, 'active': 3, 'no_activity': 4 };
                        aVal = sOrder[a.roe_status] || 99;
                        bVal = sOrder[b.roe_status] || 99;
                        break;
                    case 'days':
                        aVal = a.days_remaining === -999 ? 9999 : a.days_remaining;
                        bVal = b.days_remaining === -999 ? 9999 : b.days_remaining;
                        break;
                    case 'notes':
                        aVal = notes[a.salesforce_id] ? 0 : 1;
                        bVal = notes[b.salesforce_id] ? 0 : 1;
                        break;
                    default:
                        aVal = 0; bVal = 0;
                }
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            return filtered;
        }
        
        function renderTable(accounts) {
            const tbody = document.getElementById('accountsTable');
            
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No accounts match your filters</td></tr>';
                return;
            }
            
            const notes = getNotes();
            
            tbody.innerHTML = accounts.map(acc => {
                const daysClass = acc.days_remaining < 0 ? 'days-negative' : 
                                  acc.days_remaining <= 7 ? 'days-warning' : 'days-ok';
                const daysText = acc.days_remaining === -999 ? '-' : 
                                 acc.days_remaining < 0 ? `${Math.abs(acc.days_remaining)}d over` :
                                 `${acc.days_remaining}d`;
                
                const priorityClass = acc.priority ? `priority-${acc.priority}` : 'priority-none';
                const accountIsHot = isHot(acc.salesforce_id);
                const hotClass = accountIsHot ? 'is-hot' : '';
                const oppIndicator = acc.has_open_opp ? 'üí∞' : '<span class="opp-none">üí∞</span>';
                const noteValue = notes[acc.salesforce_id] || '';
                const noteClass = noteValue ? 'has-note' : '';
                
                return `
                    <tr>
                        <td><span class="hot-toggle ${hotClass}" onclick="toggleHot('${acc.salesforce_id}')">üî•</span></td>
                        <td>${oppIndicator}</td>
                        <td><span class="priority-badge ${priorityClass}">${acc.priority || '-'}</span></td>
                        <td>
                            <a href="${acc.salesforce_url}" target="_blank" class="account-name">${acc.name}</a>
                            <div class="account-meta">${acc.city || ''}${acc.city && acc.state ? ', ' : ''}${acc.state || ''}</div>
                        </td>
                        <td><span class="status-badge status-${acc.roe_status}">${formatStatus(acc.roe_status)}</span></td>
                        <td class="days-remaining ${daysClass}">${daysText}</td>
                        <td class="note-cell">
                            <input type="text" 
                                   class="note-input ${noteClass}" 
                                   placeholder="Add note..." 
                                   value="${escapeHtml(noteValue)}"
                                   onchange="handleNoteChange('${acc.salesforce_id}', this)"
                                   onblur="handleNoteChange('${acc.salesforce_id}', this)">
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/"/g, '&quot;');
        }
        
        function formatStatus(status) {
            const labels = {
                'expired': 'Expired',
                'expiring_soon': 'Expiring',
                'active': 'Active',
                'no_activity': 'No Activity'
            };
            return labels[status] || status;
        }
        
        // Event listeners
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const clickedFilter = btn.dataset.filter;
                
                // If clicking the same filter (not "all"), toggle back to "all"
                if (currentFilter === clickedFilter && clickedFilter !== 'all') {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-filter="all"]').classList.add('active');
                    currentFilter = 'all';
                    currentFilterType = 'all';
                } else {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = clickedFilter;
                    currentFilterType = btn.dataset.type;
                }
                renderTable(filterAndSortAccounts());
            });
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            renderTable(filterAndSortAccounts());
        });
        
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.sort;
                if (sortColumn === col) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = col;
                    sortDirection = 'asc';
                }
                document.querySelectorAll('th').forEach(t => t.classList.remove('sorted-asc', 'sorted-desc'));
                th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                renderTable(filterAndSortAccounts());
            });
        });
        
        // Load data
        loadData();
    </script>
</body>
</html>
